#!/bin/bash
#Gestión de películas de sintel

declare -A PELICULA


PELICULA=( ["id"]="" ["titulo"]="" ["fichero"]="" ["torrent"]="" ["esserie"]="" ["esvisto"]="" ["esdescargado"]="" )

#@ film.add titulo fichero torrent
function film.add() {
	local titulo="$1"
	local fichero="$2"
	local torrent="$3"

	$DEBUG && echo "> film.add" > /dev/tty
	db.executeUpdate "insert into medio (titulo, fichero, torrent, esserie, esvisto) values (\"$titulo\",\"$fichero\",$torrent,0,0,0)"
	$DEBUG && echo "< film.add" > /dev/tty
}

#@ film.add2 registro (Formato: titulo|fichero|torrent)
function film.add2() {
	local datos="$1"
	film.parse "$datos"
	local titulo="${PELICULA[titulo]}"
	local fichero="${PELICULA[fichero]}"
	local torrent="${PELICULA[torrent]}"

	db.executeUpdate "insert into medio (titulo, fichero, torrent, esserie, esvisto) values (\"$titulo\",\"$fichero\",$torrent,0,0,0)"
}

#@ film-getById id
function film.getById() {
	local id="$1"

	$DEBUG && echo "> film.getById" > /dev/tty
	local res=$(db.executeQuery "select * from medio where id = $id")
	$DEBUG && echo "< film.getById" > /dev/tty
	echo "$res"
}

#@ film.getIdByTitulo titulo
function film.getIdByTitulo() {
	local titulo="$1"

	$DEBUG && echo "> film.getByTitulo" > /dev/tty
	local res=$(db.executeQuery "select id from medio where esserie=0 and titulo = \"$titulo\"")
	$DEBUG && echo "< film.getByTitulo" > /dev/tty
	echo "$res"
}

#@ film.getByTitulo titulo
function film.getByTitulo() {
	local titulo="$1"

	$DEBUG && echo "> film.getByTitulo" > /dev/tty
	local res=$(db.executeQuery "select * from medio where esserie=0 and titulo = \"$titulo\"")
	$DEBUG && echo "< film.getByTitulo" > /dev/tty
	echo "$res"
}

#@  film-getByFichero fichero
function film.getByFichero() {
	local fichero="$1"

	local res=$(db.executeQuery "select * from medio where esserie = 0 and fichero = \"$fichero\"")
	echo "$res"
}

#@ film-find busqueda
function film.find() {
	local busqueda="$1"

	local res=$(db.executeQuery "select * from medio where esserie = 0 and titulo like \"%${busqueda}%\"")
	echo "$res"	
}

#@ film-getId titulo (sinonimo de getIdByTitulo)
function film.getId() {
	local titulo="$1"

	local id=$(db.executeQuery "select id from medio where esserie = 0 and titulo = \"$titulo\"")
}

#@ film.remove id
function film.remove() {
	local id="$1"

	db.executeUpdate "delete from medio where esserie = 0 and id = $id"
}

#@ film-updateFichero id fichero
function film.updateFichero() {
	local id="$1"
	local fichero="$2"

	db.executeUpdate "update medio set fichero=\"$fichero\" where id = $id"
}

#@ film.updateTorrent id torrent
function film.updateTorrent() {
	local id="$1"
	local torrent="$2"

	db.executeUpdate "update medio set torrent=$torrent where id = $id"
}

#@ film.setVista id
function film.setVista() {
	local id="$1"

	db.executeUpdate "update medio set esvisto=1 where id = $id"
}

#@ film.setNoVista id
function film.setNoVista() {
	local id="$1"

	db.executeUpdate "update medio set esdescargado=0 where id = $id"
}

#@ film.setDescargada id
function film.setDescargada() {
	local id="$1"

	db.executeUpdate "update medio set esdescargado=1 where id = $id"
}

#@ film.SetNoDescargada id
function film.setNoDescargada() {
	local id="$1"

	db.executeUpdate "update medio set esvisto=0 where id = $id"
}

#@ film.parse datos (Formato: (id|titulo|fichero|torrent|esserie|esvisto|esdescargado))
function film.parse() {
	local datos="$1"

	IFS='|' read -a datosa <<< "$datos"; IFS=" "
	PELICULA[id]="${datosa[0]}"
	PELICULA[titulo]="${datosa[1]}"
	PELICULA[fichero]="${datosa[2]}"
	PELICULA[torrent]="${datosa[3]}"
	PELICULA[esserie]="${datosa[4]}"
	PELICULA[esvisto]="${datosa[5]}"
	PELICULA[esdescargado]="{datosa[6]}"
}

#@ film.parseToFile datos
function film.parseToFile() {
	local datos="$1"

	film.parse "$datos"

	echo > /tmp/PELICULA
	let i=0
	for key in ${!PELICULA[@]}; do
		echo "$key ${PELICULA[$key]}" >> /tmp/PELICULA
	done
}

#@ film.getField field
function film.getField() {
	local field="$1"

	let i=0
	for key in "${!PELICULA[@]}"; do
		if [[ "$key" == "$field" ]]; then
			$DEBUG && echo "Coincide con $key. Salimos" > /dev/tty
			break
		fi
		(( i++ ))
	done
	$DEBUG && echo "El valor de i es $i" > /dev/tty
	if [[ $i < ${#PELICULA[@]} ]]; then
		local res=$(grep "^$field" /tmp/PELICULA | awk '{ print $2 };')
		echo "$res"
	else
		echo "-1"
	fi
}